#!/usr/bin/env php
<?php

namespace BecomeADeveloper\fc;

// settings
set_time_limit(0);

// init global variables
$startTimer = microtime(true);
$storage = ['longest' => 1, 'acc' => 1];
$count = 0;
$sum = 0;

function main($argc, $argv)
{
    if ($argc !== 2) {
        echo "Please, enter command: ./exec 'filename.txt'\n";
        return 1;
    }
    
    // filename
    $name = $argv[1];
    
    // include data file
    $require = __DIR__ . '/../src/' . $name;
    
    if (!is_file($require)) {
        echo "File does not exist. Path to file: 'BECOME-A-DEVELOPER/src/'\n";
        return 2;
    }
    
    if (!$file = fopen($require, 'rb')) {
        echo "Error opening file for reading\n";
        fclose($file);
        return 3;
    }

    if ($file) {
        $data = [];
        global $count;
        global $sum;
        global $storage;

        // single pass calculation
        while ($line = fgets($file)) {
            // data filtering
            $clearLine = trim($line);
            if (!is_numeric($clearLine)) {
                continue;
            } else {
                $num = intval($clearLine);
                $data[] = $num;

                $sum += $num;
                $count++;
            }
            // sequence counting
            if (!isset($prev)) {
                $prev = $num;
            }
            $longest = calculateMaxSeq($prev, $num, $storage);
            $prev = $num;
        }

        if (!feof($file)) {
            echo "Error reading from file\n";
            fclose($file);
            return 4;
        }
    }
    
    fclose($file);
    
    sort($data);

    printResult($data, $longest);
    return 0;
}

function getMax($data)
{
    global $count;
    return $data[$count - 1];
}

function getMin($data)
{
    return $data[0];
}

function calculateMedian($data)
{
    global $count;
    $middle = $count / 2;

    return ($count % 2) ? $data[ceil($middle) - 1] : ($data[$middle] + $data[$middle - 1]) / 2;
}

function calculateAverage($data)
{
    global $count;
    global $sum;
    
    return $sum / $count;
}

function calculateMaxSeq($prev, $curr, &$storage)
{
    if ($curr > $prev) {
        $storage['acc']++;
    } else {
        $storage['acc'] = 1;
    }
    
    if ($storage['acc'] > $storage['longest']) {
        $storage['longest'] = $storage['acc'];
    }

    return $storage['longest'];
}

function timer()
{
    global $startTimer;
    $stopTimer = microtime(true);
    return $stopTimer - $startTimer;
}

function printResult($data, $longest)
{
    print_r("Max: " . getMax($data) . "\n");
    print_r("Min: " . getMin($data) . "\n");
    print_r("Median: " . calculateMedian($data) . "\n");
    print_r("Average: " . calculateAverage($data) . "\n");
    print_r("Max sequence: " . $longest . "\n");
    //print_r("Min sequence: " . calculateMinSeq($prev, $curr) . "\n");

    print_r("Execution time: " . timer() . " sec\n");
}

main($argc, $argv);
